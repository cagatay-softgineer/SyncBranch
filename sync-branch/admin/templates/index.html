<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevOps Panel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .badge-healthy {
            background-color: #28a745;
        }
        .badge-unhealthy {
            background-color: #dc3545;
        }
        .badge-unreachable {
            background-color: #ffc107;
        }
        .log-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .log-content {
            max-height: 500px;
            overflow-y: auto;
            font-family: monospace;
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            line-height: 1.4;
        }
        .log-line {
            margin-bottom: 5px;
        }
        .log-info {
            color: #17a2b8;
        }
        .log-warning {
            color: #ffc107;
        }
        .log-error {
            color: #dc3545;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light mb-4">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">DevOps Panel</a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" onclick="showSection('status-section')">Server Status</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('database-section')">Database Health</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" onclick="showSection('logs-section')">Logs</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Content Sections -->
    <div class="container">
        <!-- Server Status Section -->
        <section id="status-section" class="mb-5">
            <h2>Server Status</h2>
            <canvas id="server-status-graph"></canvas>
            <ul class="list-group" id="server-status"></ul>
        </section>

        <!-- Database Health Section -->
        <section id="database-section" class="mb-5" style="display: none;">
            <h2>Database Health</h2>
            <canvas id="database-status-graph"></canvas>
            <p id="database-health" class="fs-5"></p>
        </section>

        <!-- Logs Section -->
        <section id="logs-section" style="display: none;">
            <h2>Logs</h2>
            <div>
                <h4>Available Logs</h4>
                <ul class="list-group log-list" id="log-files"></ul>
            </div>

            <div class="mt-3">
                <h4>Log Content</h4>
                <div class="input-group mb-3">
                    <input type="text" id="search-query" class="form-control" placeholder="Search logs">
                    <button class="btn btn-primary" onclick="fetchLogContent()">Search</button>
                </div>
                <div id="log-content" class="log-content"></div>
            </div>
        </section>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        async function fetchStatusHistory() {
            try {
                const response = await fetch('/status/history');
                const data = await response.json();
                if (data.status === "success") {
                    const servicesData = data.data.services;
                    const databaseData = data.data.database;
    
                    // Create or update graphs for each service
                    Object.keys(servicesData).forEach((serviceName, index) => {
                        const serviceLogs = servicesData[serviceName];
                        const labels = serviceLogs.map(log => log.timestamp);
                        const statuses = serviceLogs.map(log => log.status);
    
                        if (!document.getElementById(`service-graph-${index}`)) {
                            const canvas = document.createElement("canvas");
                            canvas.id = `service-graph-${index}`;
                            canvas.className = "mt-4";
                            document.getElementById("status-section").appendChild(canvas);
                        }
    
                        const ctx = document.getElementById(`service-graph-${index}`).getContext("2d");
    
                        // If chart already exists, update it
                        if (window[`serviceChart${index}`]) {
                            updateChart(window[`serviceChart${index}`], labels, statuses);
                        } else {
                            window[`serviceChart${index}`] = createChart(ctx, serviceName, labels, statuses);
                        }
                    });
    
                    // Update Database Chart
                    const databaseLabels = databaseData.map(entry => entry.timestamp);
                    const databaseStatuses = databaseData.map(entry => entry.status);
                    updateChart(databaseChart, databaseLabels, databaseStatuses);
                }
            } catch (error) {
                console.error("Error fetching status history:", error);
            }
        }
    
        function createChart(ctx, label, labels = [], data = []) {
            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        fill: true
                    }]
                },
                options: {
                    scales: {
                        y: {
                            ticks: {
                                callback: value => (value === 1 ? "Healthy" : "Unhealthy"),
                            },
                            beginAtZero: true,
                            max: 1,
                            min: 0
                        }
                    }
                }
            });
        }
    
        function updateChart(chart, labels, data) {
            chart.data.labels = labels;
            chart.data.datasets[0].data = data;
            chart.update();
        }
    
        // Initialize Database Chart
        const databaseCtx = document.getElementById('database-status-graph').getContext('2d');
        databaseChart = createChart(databaseCtx, 'Database Health');
    
        // Fetch initial data and set interval for updates
        fetchStatusHistory();
        setInterval(fetchStatusHistory, 300000); // 5 minutes
    </script>
    <script>
        // Show selected section and hide others
        function showSection(sectionId) {
            const sections = document.querySelectorAll('section');
            sections.forEach(section => {
                section.style.display = section.id === sectionId ? 'block' : 'none';
            });

            // Update active link in navbar
            const links = document.querySelectorAll('.nav-link');
            links.forEach(link => {
                link.classList.toggle('active', link.getAttribute('onclick').includes(sectionId));
            });
        }

        // Fetch server status
        async function fetchData(url, elementId, formatter) {
            const element = document.getElementById(elementId);
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                formatter(element, data);
            } catch (error) {
                element.innerHTML = `<span class="text-danger">Error: ${error.message}</span>`;
            }
        }

        function formatServerStatus(element, data) {
            element.innerHTML = data.map(server => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${server.name}
                    <span class="badge ${
                        server.status === 'Healthy' ? 'badge-healthy' : 
                        server.status === 'Unhealthy' ? 'badge-unhealthy' : 'badge-unreachable'
                    }">${server.status}</span>
                </li>
            `).join('');
        }

        function formatDatabaseHealth(element, data) {
            element.innerHTML = `
                <span class="badge ${
                    data.status === 'Healthy' ? 'badge-healthy' : 'badge-unhealthy'
                }">${data.status}</span>
                ${data.error ? `<span class="text-danger ms-2">${data.error}</span>` : ''}
            `;
        }

        // Logs functionality
        let selectedLogFile = null;

        async function fetchLogFiles() {
            const logFilesElement = document.getElementById("log-files");
            try {
                const response = await fetch("/logs");
                const data = await response.json();
                if (data.status === "success") {
                    logFilesElement.innerHTML = data.files.map(file => `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            ${file}
                            <button class="btn btn-sm btn-primary" onclick="selectLogFile('${file}')">Open</button>
                        </li>
                    `).join("");
                } else {
                    logFilesElement.innerHTML = `<li class="list-group-item text-danger">${data.message}</li>`;
                }
            } catch (error) {
                logFilesElement.innerHTML = `<li class="list-group-item text-danger">Error: ${error.message}</li>`;
            }
        }

        function selectLogFile(file) {
            selectedLogFile = file;
            fetchLogContent();
        }

        async function fetchLogContent() {
            if (!selectedLogFile) {
                document.getElementById("log-content").textContent = "Please select a log file.";
                return;
            }

            const query = document.getElementById("search-query").value;
            const url = `/logs/${selectedLogFile}?query=${query}`;
            const logContentElement = document.getElementById("log-content");

            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.status === "success") {
                    logContentElement.innerHTML = data.logs.map(line => `
                        <div class="log-line ${
                            line.includes('ERROR') ? 'log-error' : 
                            line.includes('WARNING') ? 'log-warning' : 'log-info'
                        }">${line}</div>
                    `).join('');
                } else {
                    logContentElement.textContent = `Error: ${data.message}`;
                }
            } catch (error) {
                logContentElement.textContent = `Error: ${error.message}`;
            }
        }

        // Initial data fetch
        fetchLogFiles();
        fetchData('/status', 'server-status', formatServerStatus);
        fetchData('/database', 'database-health', formatDatabaseHealth);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
